<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TileMap.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BatBat-Game</a> &gt; <a href="index.source.html" class="el_package">al.tonikolaba.tilemap</a> &gt; <span class="el_source">TileMap.java</span></div><h1>TileMap.java</h1><pre class="source lang-java linenums">package al.tonikolaba.tilemap;

import al.tonikolaba.handlers.LoggingHelper;
import al.tonikolaba.main.GamePanel;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.logging.Level;
import java.security.SecureRandom;
/**
 * @author ArtOfSoul
 */

public class TileMap {

    // Agregamos los cambios para solventar security hotspots
<span class="fc" id="L21">    private static final SecureRandom SECURE_RANDOM = new SecureRandom();</span>
    // position
    private double x;
    private double y;

    // bounds
    private int xmin;
    private int ymin;
    private int xmax;
    private int ymax;

    private double tween;

    // map
    private int[][] map;
    private int tileSize;
    private int numRows;
    private int numCols;
    private int width;
    private int height;

    // tileset
    private int numTilesAcross;
    private Tile[][] tiles;

    // drawing
    private int rowOffset;
    private int colOffset;
    private int numRowsToDraw;
    private int numColsToDraw;

    // effects
    private boolean shaking;
    private int intensity;

<span class="fc" id="L56">    public TileMap(int tileSize) {</span>
<span class="fc" id="L57">        this.tileSize = tileSize;</span>
<span class="fc" id="L58">        numRowsToDraw = GamePanel.HEIGHT / tileSize + 2;</span>
<span class="fc" id="L59">        numColsToDraw = GamePanel.WIDTH / tileSize + 2;</span>
<span class="fc" id="L60">        tween = 0.07;</span>
<span class="fc" id="L61">    }</span>

    public void loadTiles(String s) {

        try {
            BufferedImage tileset;
<span class="fc" id="L67">            tileset = ImageIO.read(getClass().getResourceAsStream(s));</span>
<span class="fc" id="L68">            numTilesAcross = tileset.getWidth() / tileSize;</span>
<span class="fc" id="L69">            tiles = new Tile[2][numTilesAcross];</span>

            BufferedImage subimage;
<span class="fc bfc" id="L72" title="All 2 branches covered.">            for (int col = 0; col &lt; numTilesAcross; col++) {</span>
<span class="fc" id="L73">                subimage = tileset.getSubimage(col * tileSize, 0, tileSize, tileSize);</span>
<span class="fc" id="L74">                tiles[0][col] = new Tile(subimage, Tile.NORMAL);</span>
<span class="fc" id="L75">                subimage = tileset.getSubimage(col * tileSize, tileSize, tileSize, tileSize);</span>
<span class="fc" id="L76">                tiles[1][col] = new Tile(subimage, Tile.BLOCKED);</span>
            }

<span class="nc" id="L79">        } catch (Exception e) {</span>
<span class="nc" id="L80">            LoggingHelper.LOGGER.log(Level.SEVERE, e.getMessage());</span>
<span class="fc" id="L81">        }</span>

<span class="fc" id="L83">    }</span>

    public void loadMap(String s) {

        try {

<span class="fc" id="L89">            InputStream in = getClass().getResourceAsStream(s);</span>
<span class="fc" id="L90">            BufferedReader br = new BufferedReader(new InputStreamReader(in));</span>

<span class="fc" id="L92">            numCols = Integer.parseInt(br.readLine());</span>
<span class="fc" id="L93">            numRows = Integer.parseInt(br.readLine());</span>
<span class="fc" id="L94">            map = new int[numRows][numCols];</span>
<span class="fc" id="L95">            width = numCols * tileSize;</span>
<span class="fc" id="L96">            height = numRows * tileSize;</span>

<span class="fc" id="L98">            xmin = GamePanel.WIDTH - width;</span>
<span class="fc" id="L99">            xmax = 0;</span>
<span class="fc" id="L100">            ymin = GamePanel.HEIGHT - height;</span>
<span class="fc" id="L101">            ymax = 0;</span>

<span class="fc" id="L103">            String delims = &quot;\\s+&quot;;</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            for (int row = 0; row &lt; numRows; row++) {</span>
<span class="fc" id="L105">                String line = br.readLine();</span>
<span class="fc" id="L106">                String[] tokens = line.split(delims);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                for (int col = 0; col &lt; numCols; col++) {</span>
<span class="fc" id="L108">                    map[row][col] = Integer.parseInt(tokens[col]);</span>
                }
            }

<span class="fc" id="L112">        } catch (Exception e) {</span>
<span class="fc" id="L113">            LoggingHelper.LOGGER.log(Level.SEVERE, e.getMessage());</span>
<span class="nc" id="L114">        }</span>

<span class="fc" id="L116">    }</span>

    public int getTileSize() {
<span class="fc" id="L119">        return tileSize;</span>
    }

    public double getx() {
<span class="nc" id="L123">        return x;</span>
    }

    public double gety() {
<span class="nc" id="L127">        return y;</span>
    }

    public int getWidth() {
<span class="fc" id="L131">        return width;</span>
    }

    public int getHeight() {
<span class="fc" id="L135">        return height;</span>
    }

    public int getNumRows() {
<span class="fc" id="L139">        return numRows;</span>
    }

    public int getNumCols() {
<span class="nc" id="L143">        return numCols;</span>
    }

    public int getType(int row, int col) {
<span class="nc" id="L147">        int rc = map[row][col];</span>
<span class="nc" id="L148">        int r = rc / numTilesAcross;</span>
<span class="nc" id="L149">        int c = rc % numTilesAcross;</span>
<span class="nc" id="L150">        return tiles[r][c].getType();</span>
    }

    public boolean isShaking() {
<span class="nc" id="L154">        return shaking;</span>
    }

    public void setTween(double d) {
<span class="fc" id="L158">        tween = d;</span>
<span class="fc" id="L159">    }</span>

    public void setShaking(boolean b, int i) {
<span class="nc" id="L162">        shaking = b;</span>
<span class="nc" id="L163">        intensity = i;</span>
<span class="nc" id="L164">    }</span>

    public void setBounds(int i1, int i2, int i3, int i4) {
<span class="fc" id="L167">        xmin = GamePanel.WIDTH - i1;</span>
<span class="fc" id="L168">        ymin = GamePanel.WIDTH - i2;</span>
<span class="fc" id="L169">        xmax = i3;</span>
<span class="fc" id="L170">        ymax = i4;</span>
<span class="fc" id="L171">    }</span>

    public void setPosition(double x, double y) {

<span class="fc" id="L175">        this.x += (x - this.x) * tween;</span>
<span class="fc" id="L176">        this.y += (y - this.y) * tween;</span>

<span class="fc" id="L178">        fixBounds();</span>

<span class="fc" id="L180">        colOffset = (int) -this.x / tileSize;</span>
<span class="fc" id="L181">        rowOffset = (int) -this.y / tileSize;</span>

<span class="fc" id="L183">    }</span>

    public void fixBounds() {
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (x &lt; xmin)</span>
<span class="nc" id="L187">            x = xmin;</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (y &lt; ymin)</span>
<span class="nc" id="L189">            y = ymin;</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (x &gt; xmax)</span>
<span class="fc" id="L191">            x = xmax;</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (y &gt; ymax)</span>
<span class="fc" id="L193">            y = ymax;</span>
<span class="fc" id="L194">    }</span>

    public void update() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (shaking) {</span>
<span class="nc" id="L198">            this.x += SECURE_RANDOM.nextDouble() * intensity - intensity / 2.0;</span>
<span class="nc" id="L199">            this.y += SECURE_RANDOM.nextDouble() * intensity - intensity / 2.0;</span>
        }
<span class="nc" id="L201">    }</span>

    public void draw(Graphics2D g) {

<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (int row = rowOffset; row &lt; rowOffset + numRowsToDraw; row++) {</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (row &gt;= numRows)</span>
<span class="nc" id="L208">                break;</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">            for (int col = colOffset; col &lt; colOffset + numColsToDraw; col++) {</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (col &gt;= numCols)</span>
<span class="nc" id="L213">                    break;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (map[row][col] != 0) {</span>

<span class="nc" id="L216">                    int rc = map[row][col];</span>
<span class="nc" id="L217">                    int r = rc / numTilesAcross;</span>
<span class="nc" id="L218">                    int c = rc % numTilesAcross;</span>

<span class="nc" id="L220">                    g.drawImage(tiles[r][c].getImage(), (int) x + col * tileSize, (int) y + row * tileSize, null);</span>
                }

            }

        }

<span class="nc" id="L227">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>