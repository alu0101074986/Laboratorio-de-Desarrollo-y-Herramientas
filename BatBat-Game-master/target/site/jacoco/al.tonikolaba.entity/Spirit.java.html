<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Spirit.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BatBat-Game</a> &gt; <a href="index.source.html" class="el_package">al.tonikolaba.entity</a> &gt; <span class="el_source">Spirit.java</span></div><h1>Spirit.java</h1><pre class="source lang-java linenums">package al.tonikolaba.entity;

import java.awt.Graphics2D;
import java.awt.image.BufferedImage;
import java.security.SecureRandom;
import java.util.ArrayList;

import javax.imageio.ImageIO;

import al.tonikolaba.entity.enemies.RedEnergy;
import al.tonikolaba.tilemap.TileMap;

import java.util.logging.Level;
import java.util.logging.Logger;
/**
 * @author N. Kolaba
 */

public class Spirit extends Enemy {

	/*Agregamos las modificaciones para solvertar security hotspots*/
<span class="nc" id="L22">	private static final Logger LOGGER = Logger.getLogger(Spirit.class.getName());</span>
<span class="nc" id="L23">	private static final SecureRandom SECURE_RANDOM = new SecureRandom();</span>

	public BufferedImage[] sprites;
	private Player player;
	private ArrayList&lt;Enemy&gt; enemies;
	private ArrayList&lt;Explosion&gt; explosions;

	private boolean active;
	private boolean finalAttack;

	private int step;
	private int stepCount;

	// attack pattern
<span class="nc" id="L37">	private int[] steps = { 0, 1, 0, 1, 2, 1, 0, 2, 1, 2 };</span>

	//// attacks:
	// fly around throwing dark energy (0)
	// floor sweep (1)
	// crash down on floor to create shockwave (2)
	//// special:
	// after half hp, create shield
	// after quarter hp, bullet hell

	private RedEnergy[] shield;
	private double ticks;

	public Spirit(TileMap tm, Player p, ArrayList&lt;Enemy&gt; enemies, ArrayList&lt;Explosion&gt; explosions) {

<span class="nc" id="L52">		super(tm);</span>
<span class="nc" id="L53">		player = p;</span>
<span class="nc" id="L54">		this.enemies = enemies;</span>
<span class="nc" id="L55">		this.explosions = explosions;</span>

<span class="nc" id="L57">		width = 40;</span>
<span class="nc" id="L58">		height = 40;</span>
<span class="nc" id="L59">		cwidth = 30;</span>
<span class="nc" id="L60">		cheight = 30;</span>

<span class="nc" id="L62">		health = maxHealth = 80;</span>

<span class="nc" id="L64">		moveSpeed = 1.4;</span>

		try {
<span class="nc" id="L67">			BufferedImage spritesheet = ImageIO.read(getClass().getResourceAsStream(&quot;/Sprites/Enemies/Spirit.gif&quot;));</span>
<span class="nc" id="L68">			sprites = new BufferedImage[4];</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">			for (int i = 0; i &lt; sprites.length; i++) {</span>
<span class="nc" id="L70">				sprites[i] = spritesheet.getSubimage(i * width, 0, width, height);</span>
			}
<span class="nc" id="L72">		} catch (Exception e) {</span>
<span class="nc" id="L73">			LOGGER.log(Level.SEVERE, &quot;Error loading sprites&quot;, e);</span>
<span class="nc" id="L74">		}</span>


<span class="nc" id="L77">		damage = 1;</span>

<span class="nc" id="L79">		animation.setFrames(sprites);</span>
<span class="nc" id="L80">		animation.setDelay(1);</span>

<span class="nc" id="L82">		shield = new RedEnergy[2];</span>

<span class="nc" id="L84">		step = 0;</span>
<span class="nc" id="L85">		stepCount = 0;</span>

<span class="nc" id="L87">	}</span>

	public void setActive() {
<span class="nc" id="L90">		active = true;</span>
<span class="nc" id="L91">	}</span>

	@Override
	public void update() {

<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (health == 0)</span>
<span class="nc" id="L97">			return;</span>

		// restart attack pattern
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (step == steps.length) {</span>
<span class="nc" id="L101">			step = 0;</span>
		}

<span class="nc" id="L104">		ticks++;</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">		if (flinching) {</span>
<span class="nc" id="L107">			flinchCount++;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if (flinchCount == 8)</span>
<span class="nc" id="L109">				flinching = false;</span>
		}

<span class="nc" id="L112">		x += dx;</span>
<span class="nc" id="L113">		y += dy;</span>

<span class="nc" id="L115">		animation.update();</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (!active)</span>
<span class="nc" id="L118">			return;</span>

		////////////
		// special
		////////////
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (health &lt;= maxHealth / 2) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (shield[0] == null) {</span>
<span class="nc" id="L125">				shield[0] = new RedEnergy(tileMap);</span>
<span class="nc" id="L126">				shield[0].setPermanent(true);</span>
<span class="nc" id="L127">				enemies.add(shield[0]);</span>
			}
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (shield[1] == null) {</span>
<span class="nc" id="L130">				shield[1] = new RedEnergy(tileMap);</span>
<span class="nc" id="L131">				shield[0].setPermanent(true);</span>
<span class="nc" id="L132">				enemies.add(shield[1]);</span>
			}
<span class="nc" id="L134">			double pos = ticks / 32;</span>
<span class="nc" id="L135">			shield[0].setPosition(x + 30 * Math.sin(pos), y + 30 * Math.cos(pos));</span>
<span class="nc" id="L136">			pos += 3.1415;</span>
<span class="nc" id="L137">			shield[1].setPosition(x + 30 * Math.sin(pos), y + 30 * Math.cos(pos));</span>
		}

<span class="nc bnc" id="L140" title="All 4 branches missed.">		if (!finalAttack &amp;&amp; health &lt;= maxHealth / 4) {</span>
<span class="nc" id="L141">			stepCount = 0;</span>
<span class="nc" id="L142">			finalAttack = true;</span>
		}

<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (finalAttack) {</span>
<span class="nc" id="L146">			stepCount++;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (stepCount == 1) {</span>
<span class="nc" id="L148">				explosions.add(new Explosion(tileMap, (int) x, (int) y));</span>
<span class="nc" id="L149">				x = -9000;</span>
<span class="nc" id="L150">				y = 9000;</span>
<span class="nc" id="L151">				dx = dy = 0;</span>
			}
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if (stepCount == 60) {</span>
<span class="nc" id="L154">				x = tileMap.getWidth() / 2;</span>
<span class="nc" id="L155">				y = tileMap.getHeight() / 2;</span>
<span class="nc" id="L156">				explosions.add(new Explosion(tileMap, (int) x, (int) y));</span>
			}
<span class="nc bnc" id="L158" title="All 4 branches missed.">			if (stepCount &gt;= 90 &amp;&amp; stepCount % 30 == 0) {</span>
<span class="nc" id="L159">				RedEnergy de = new RedEnergy(tileMap);</span>
<span class="nc" id="L160">				de.setPosition(x, y);</span>
<span class="nc" id="L161">				de.setVector(3 * Math.sin(stepCount / 32), 3 * Math.cos(stepCount / 32));</span>
<span class="nc" id="L162">				de.setType(RedEnergy.BOUNCE);</span>
<span class="nc" id="L163">				enemies.add(de);</span>
			}
<span class="nc" id="L165">			return;</span>
		}

		////////////
		// attacks
		////////////

		// fly around dropping bombs
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (steps[step] == 0) {</span>
<span class="nc" id="L174">			stepCount++;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (y &gt; 60) {</span>
<span class="nc" id="L176">				dy = -4;</span>
			}
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (y &lt; 60) {</span>
<span class="nc" id="L179">				dy = 0;</span>
<span class="nc" id="L180">				y = 60;</span>
<span class="nc" id="L181">				dx = -1;</span>
			}
<span class="nc bnc" id="L183" title="All 2 branches missed.">			if (y == 60) {</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">				if (dx == -1 &amp;&amp; x &lt; 60) {</span>
<span class="nc" id="L185">					dx = 1;</span>
				}
<span class="nc bnc" id="L187" title="All 4 branches missed.">				if (dx == 1 &amp;&amp; x &gt; tileMap.getWidth() - 60) {</span>
<span class="nc" id="L188">					dx = -1;</span>
				}
			}
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (stepCount % 10 == 0) { // 60 per te hedhur me shpesh bombat</span>
<span class="nc" id="L192">				RedEnergy de = new RedEnergy(tileMap);</span>
<span class="nc" id="L193">				de.setType(RedEnergy.GRAVITY);</span>
<span class="nc" id="L194">				de.setPosition(x, y);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">				int dir = SECURE_RANDOM.nextBoolean() ? 1 : -1;</span>
<span class="nc" id="L196">				de.setVector(dir, 0);</span>
<span class="nc" id="L197">				enemies.add(de);</span>
			}
<span class="nc bnc" id="L199" title="All 2 branches missed.">			if (stepCount == 559) {</span>
<span class="nc" id="L200">				step++;</span>
<span class="nc" id="L201">				stepCount = 0;</span>
<span class="nc" id="L202">				right = left = false;</span>
			}
		}
		// floor sweep
<span class="nc bnc" id="L206" title="All 2 branches missed.">		else if (steps[step] == 1) {</span>
<span class="nc" id="L207">			stepCount++;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (stepCount == 1) {</span>
<span class="nc" id="L209">				explosions.add(new Explosion(tileMap, (int) x, (int) y));</span>
<span class="nc" id="L210">				x = -9000;</span>
<span class="nc" id="L211">				y = 9000;</span>
<span class="nc" id="L212">				dx = dy = 0;</span>
			}
<span class="nc bnc" id="L214" title="All 2 branches missed.">			if (stepCount == 60) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (player.getx() &gt; tileMap.getWidth() / 2) {</span>
<span class="nc" id="L216">					x = 30;</span>
<span class="nc" id="L217">					y = tileMap.getHeight() - 60;</span>
<span class="nc" id="L218">					dx = 4;</span>
				} else {
<span class="nc" id="L220">					x = tileMap.getWidth() - 30;</span>
<span class="nc" id="L221">					y = tileMap.getHeight() - 60;</span>
<span class="nc" id="L222">					dx = -4;</span>
				}
<span class="nc" id="L224">				explosions.add(new Explosion(tileMap, (int) x, (int) y));</span>
			}
<span class="nc bnc" id="L226" title="All 8 branches missed.">			if ((dx == -4 &amp;&amp; x &lt; 30) || (dx == 4 &amp;&amp; x &gt; tileMap.getWidth() - 30)) {</span>
<span class="nc" id="L227">				stepCount = 0;</span>
<span class="nc" id="L228">				step++;</span>
<span class="nc" id="L229">				dx = dy = 0;</span>
			}

		}
		// shockwave
<span class="nc bnc" id="L234" title="All 2 branches missed.">		else if (steps[step] == 2) {</span>
<span class="nc" id="L235">			stepCount++;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">			if (stepCount == 1) {</span>
<span class="nc" id="L237">				x = tileMap.getWidth() - 50; // zbret poshte dhe gjuan topat ne drejtim horzontal-poshte</span>
<span class="nc" id="L238">				y = 60; // 40 nise nga pika lart duke zbrit poshte</span>
			}
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (stepCount == 30) { // 60 // per te shtuar hedhjen a bombave nag e majta ne te djatht</span>
<span class="nc" id="L241">				dy = 73; // 7 leviz hedhjen e batbat ne drejtim me poshte</span>
			}
<span class="nc bnc" id="L243" title="All 2 branches missed.">			if (y &gt;= tileMap.getHeight() - 260) { // per te gjuartur kur arrin ne fund afer Batbat-it</span>
<span class="nc" id="L244">				dy = 0;</span>
			}
<span class="nc bnc" id="L246" title="All 8 branches missed.">			if (stepCount &gt; 60 &amp;&amp; stepCount &lt; 120 &amp;&amp; stepCount % 2 == 0 &amp;&amp; dy == 0) { // %5</span>
<span class="nc" id="L247">				RedEnergy de = new RedEnergy(tileMap);</span>
<span class="nc" id="L248">				de.setType(RedEnergy.GRAVITY);</span>
<span class="nc" id="L249">				de.setPosition(x, y);</span>
<span class="nc" id="L250">				de.setVector(-12, 0); // -3 //per te hedhur topat majtas djathats me shpejt</span>
<span class="nc" id="L251">				enemies.add(de);</span>
<span class="nc" id="L252">				de = new RedEnergy(tileMap);</span>
<span class="nc" id="L253">				de.setType(RedEnergy.GRAVITY);</span>
<span class="nc" id="L254">				de.setPosition(x, y);</span>
<span class="nc" id="L255">				de.setVector(9, 0); // 3</span>
<span class="nc" id="L256">				enemies.add(de);</span>
			}
<span class="nc bnc" id="L258" title="All 2 branches missed.">			if (stepCount == 420) {</span>
<span class="nc" id="L259">				stepCount = 0;</span>
<span class="nc" id="L260">				step++;</span>
			}
		}
<span class="nc" id="L263">	}</span>

	@Override
	public void draw(Graphics2D g) {
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (flinching) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">			if (flinchCount % 4 &lt; 2)</span>
<span class="nc" id="L269">				return;</span>
		}
<span class="nc" id="L271">		super.draw(g);</span>
<span class="nc" id="L272">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>